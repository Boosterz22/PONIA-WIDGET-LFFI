import { useState } from "react";
import { X, CheckCircle2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { ChainSelector } from "./ChainSelector";
import { SwapProgress } from "./SwapProgress";
import { BLOCKCHAIN_INFO, detectChainFromUrl, generateTxHash } from "@/lib/chains";
import type { Blockchain } from "@shared/schema";
import poniaLogo from "/ponia-logo.png";

interface SwapWidgetProps {
  onClose?: () => void;
}

type SwapStage = "select" | "processing" | "success";

export function SwapWidget({ onClose }: SwapWidgetProps) {
  const destinationChain = detectChainFromUrl();
  const destinationInfo = BLOCKCHAIN_INFO[destinationChain];

  const defaultSource = Object.keys(BLOCKCHAIN_INFO).find(
    (c) => c !== destinationChain
  ) as Blockchain;

  const [sourceChain, setSourceChain] = useState<Blockchain>(defaultSource);
  const [stage, setStage] = useState<SwapStage>("select");
  const [txHash, setTxHash] = useState<string>("");

  const sourceInfo = BLOCKCHAIN_INFO[sourceChain];

  const handleConfirm = () => {
    setStage("processing");
    console.info("Ponia Demo: Starting swap", {
      source: sourceChain,
      destination: destinationChain,
    });
  };

  const handleSwapComplete = () => {
    const hash = generateTxHash();
    setTxHash(hash);
    setStage("success");
    console.info("Ponia Demo: Swap completed", {
      source: sourceChain,
      destination: destinationChain,
      txHash: hash,
    });
  };

  const handleClose = () => {
    if (onClose) {
      onClose();
    }
  };

  return (
    <Card className="w-full max-w-md mx-auto bg-gradient-to-b from-card/95 to-card shadow-2xl border-border overflow-hidden">
      {/* Header */}
      <div className="flex items-center justify-between p-5 border-b border-border">
        <div className="flex items-center gap-3">
          <img 
            src={poniaLogo} 
            alt="Ponia" 
            className="h-8 w-auto object-contain"
          />
          <div>
            <div className="font-bold text-base text-foreground font-heading">Ponia Demo</div>
            <div className="text-xs text-muted-foreground">Cross-chain swap</div>
          </div>
        </div>
        {onClose && (
          <button
            onClick={handleClose}
            className="text-muted-foreground hover:text-foreground transition-colors"
            aria-label="Close widget"
            data-testid="button-close-widget"
          >
            <X className="w-5 h-5" />
          </button>
        )}
      </div>

      {/* Main Content */}
      <div className="p-5">
        {stage === "select" && (
          <div className="space-y-6">
            {/* Detected Platform Chain Display */}
            <div className="flex flex-col items-center gap-3 py-4">
              <div className="w-28 h-28 rounded-2xl bg-muted/10 flex items-center justify-center p-6">
                <img
                  src={destinationInfo.logo}
                  alt={`${destinationInfo.displayName} logo`}
                  className="w-full h-full object-contain"
                  data-testid="img-platform-chain"
                />
              </div>
              <p className="text-sm text-muted-foreground" data-testid="text-detected-chain">
                This platform uses:{" "}
                <strong className="text-foreground">{destinationInfo.displayName}</strong>
              </p>
            </div>

            {/* Source Selector */}
            <div className="space-y-3">
              <div className="text-center font-bold text-sm text-foreground font-heading">
                Send from which chain?
              </div>
              <ChainSelector
                selectedChain={sourceChain}
                onSelect={setSourceChain}
                excludeChain={destinationChain}
              />
            </div>

            {/* Info and CTA */}
            <div className="space-y-3">
              <p className="text-xs text-center text-muted-foreground">
                Platform blockchain detected automatically. Choose which wallet you want to send from.
              </p>
              <Button
                onClick={handleConfirm}
                className="w-full"
                size="lg"
                data-testid="button-confirm-swap"
              >
                Confirm swap
              </Button>
            </div>
          </div>
        )}

        {stage === "processing" && (
          <div className="space-y-6 py-8">
            <div className="flex flex-col items-center gap-4">
              <div className="flex items-center gap-4">
                <div className="w-16 h-16 rounded-xl bg-muted/10 flex items-center justify-center p-3">
                  <img
                    src={sourceInfo.logo}
                    alt={sourceInfo.displayName}
                    className="w-full h-full object-contain"
                  />
                </div>
                <div className="text-2xl text-primary animate-pulse-slide">→</div>
                <div className="w-16 h-16 rounded-xl bg-muted/10 flex items-center justify-center p-3">
                  <img
                    src={destinationInfo.logo}
                    alt={destinationInfo.displayName}
                    className="w-full h-full object-contain"
                  />
                </div>
              </div>
              <div className="text-center">
                <p className="font-semibold text-foreground">
                  {sourceInfo.displayName} → {destinationInfo.displayName}
                </p>
                <p className="text-xs text-muted-foreground mt-1">
                  Converting your funds to platform currency
                </p>
              </div>
            </div>
            <SwapProgress duration={8000} onComplete={handleSwapComplete} />
          </div>
        )}

        {stage === "success" && (
          <div className="space-y-6 py-8" data-testid="success-screen">
            <div className="flex flex-col items-center gap-4">
              <div className="w-16 h-16 bg-chart-2/10 rounded-full flex items-center justify-center">
                <CheckCircle2 className="w-10 h-10 text-chart-2" />
              </div>
              <div className="text-center space-y-2">
                <h3 className="font-bold text-lg text-foreground font-heading">
                  Swap Successful!
                </h3>
                <p className="text-sm text-muted-foreground">
                  Funds arrived instantly on {destinationInfo.displayName}
                </p>
              </div>
            </div>

            <div className="space-y-3">
              <div className="flex items-center justify-center gap-3 text-sm text-muted-foreground">
                <span>{sourceInfo.displayName}</span>
                <span>→</span>
                <span>{destinationInfo.displayName}</span>
              </div>
              <div className="bg-muted/30 rounded-lg p-4 space-y-2">
                <div className="text-xs text-muted-foreground">Transaction ID</div>
                <div
                  className="text-xs font-mono break-all text-foreground"
                  data-testid="text-tx-hash"
                >
                  {txHash}
                </div>
              </div>
            </div>

            <Button
              onClick={handleClose}
              variant="outline"
              className="w-full"
              data-testid="button-close-success"
            >
              Close
            </Button>
          </div>
        )}
      </div>
    </Card>
  );
}